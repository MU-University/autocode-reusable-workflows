name: Reusable Maven Build and Test

on:
  workflow_call:
    inputs:
      java-version:
        description: 'Java version to use'
        required: false
        type: string
        default: '17'
      java-distribution:
        description: 'Java distribution to use'
        required: false
        type: string
        default: 'temurin'
      artifact-name:
        description: 'Name for the test results artifact'
        required: false
        type: string
        default: 'test-results'
      webhook-url:
        description: 'Webhook URL for notifications'
        required: false
        type: string
        default: ''
      template-repo:
        description: 'Template repository containing tests (e.g., your-org/template-repo)'
        required: false
        type: string
        default: ''
      template-tests-path:
        description: 'Path to tests in template repo (e.g., src/test/java)'
        required: false
        type: string
        default: 'src/test/java'
      template-ref:
        description: 'Branch/tag/commit to checkout from template repo'
        required: false
        type: string
        default: 'main'
    secrets:
      WEBHOOK_URL:
        description: 'Webhook URL (as secret)'
        required: false
      TEMPLATE_REPO_TOKEN:
        description: 'Token to access template repository (if private)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout student repository
      uses: actions/checkout@v4
      with:
        path: student-repo

    - name: Checkout template repository with tests
      if: inputs.template-repo != ''
      uses: actions/checkout@v4
      with:
        repository: ${{ inputs.template-repo }}
        ref: ${{ inputs.template-ref }}
        token: ${{ secrets.TEMPLATE_REPO_TOKEN || github.token }}
        path: template-repo

    - name: Copy tests from template to student repo
      if: inputs.template-repo != ''
      run: |
        echo "Copying tests from template-repo/${{ inputs.template-tests-path }} to student-repo/${{ inputs.template-tests-path }}"
        mkdir -p student-repo/${{ inputs.template-tests-path }}
        cp -r template-repo/${{ inputs.template-tests-path }}/* student-repo/${{ inputs.template-tests-path }}/
        echo "Tests copied successfully"
        ls -la student-repo/${{ inputs.template-tests-path }}

    - name: Set up JDK ${{ inputs.java-version }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ inputs.java-version }}
        distribution: ${{ inputs.java-distribution }}

    - name: Print Repository Structure
      working-directory: student-repo
      run: |
        echo "======================================"
        echo "üìÅ PROJECT STRUCTURE"
        echo "======================================"
        echo ""
        echo "üìÇ Root directory contents:"
        ls -la
        echo ""
        echo "üìÇ Full directory tree:"
        find . -type f -not -path '*/\.*' | head -50
        echo ""
        echo "‚òï Java source files:"
        find src -name "*.java" -type f 2>/dev/null || echo "No src directory found"
        echo ""
        echo "üß™ Test files:"
        find src/test -name "*.java" -type f 2>/dev/null || echo "No test directory found"
        echo ""
        echo "======================================"

    - name: Verify Maven project structure
      working-directory: student-repo
      run: |
        echo "======================================"
        echo "‚úÖ MAVEN PROJECT VERIFICATION"
        echo "======================================"
        echo ""
        echo "Checking for pom.xml..."
        if [ ! -f "pom.xml" ]; then
          echo "‚ùå ERROR: pom.xml not found in student repository"
          echo "This workflow requires a Maven project with a pom.xml file"
          echo ""
          echo "Current directory contents:"
          ls -la
          exit 1
        fi
        echo "‚úÖ pom.xml found successfully"
        echo ""
        echo "üìÑ POM.xml content preview:"
        head -20 pom.xml
        echo ""
        echo "======================================"

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
        restore-keys: |
          ${{ runner.os }}-maven-

    - name: Build with Maven
      id: build
      continue-on-error: true
      working-directory: student-repo
      run: |
        echo "======================================"
        echo "üî® BUILDING PROJECT"
        echo "======================================"
        echo ""
        mvn -B compile
        BUILD_RESULT=$?
        echo ""
        echo "======================================"
        if [ $BUILD_RESULT -eq 0 ]; then
          echo "‚úÖ Build completed successfully"
          echo ""
          echo "üì¶ Compiled classes:"
          find target/classes -name "*.class" 2>/dev/null | head -20
        else
          echo "‚ùå Build failed with exit code: $BUILD_RESULT"
        fi
        echo "======================================"
        exit $BUILD_RESULT

    - name: Generate Build Error Report
      if: steps.build.outcome == 'failure'
      working-directory: student-repo
      run: |
        echo "======================================"
        echo "‚ùå GENERATING BUILD ERROR REPORT"
        echo "======================================"
        mkdir -p target/surefire-reports
        echo '<?xml version="1.0" encoding="UTF-8"?>' > target/surefire-reports/test-results.xml
        echo '<testsuites>' >> target/surefire-reports/test-results.xml
        echo '  <testsuite name="Build Error" time="0" tests="1" errors="1" skipped="0" failures="1">' >> target/surefire-reports/test-results.xml
        echo '    <testcase name="Build" classname="BuildError" time="0">' >> target/surefire-reports/test-results.xml
        echo '      <failure type="Compilation Error"><![CDATA[Maven build failed. Check the build logs for compilation errors.]]></failure>' >> target/surefire-reports/test-results.xml
        echo '    </testcase>' >> target/surefire-reports/test-results.xml
        echo '  </testsuite>' >> target/surefire-reports/test-results.xml
        echo '</testsuites>' >> target/surefire-reports/test-results.xml

    - name: Run Tests with Maven
      id: test
      if: steps.build.outcome == 'success'
      continue-on-error: true
      working-directory: student-repo
      run: |
        echo "======================================"
        echo "üß™ RUNNING TESTS"
        echo "======================================"
        echo ""
        echo "Test files to be executed:"
        find src/test -name "*Test.java" -o -name "*Tests.java" 2>/dev/null
        echo ""
        mvn -B test
        TEST_RESULT=$?
        echo ""
        echo "======================================"
        if [ $TEST_RESULT -eq 0 ]; then
          echo "‚úÖ All tests passed"
        else
          echo "‚ùå Some tests failed (exit code: $TEST_RESULT)"
        fi
        echo ""
        echo "üìä Test Results Summary:"
        if [ -d "target/surefire-reports" ]; then
          echo "Test report files generated:"
          ls -lh target/surefire-reports/
          echo ""
          echo "Test summary from XML reports:"
          grep -h "testsuite" target/surefire-reports/*.xml 2>/dev/null | head -5 || echo "No test results found"
        fi
        echo "======================================"
        exit $TEST_RESULT

    - name: Show Test Results Before Upload
      if: always()
      working-directory: student-repo
      run: |
        echo "======================================"
        echo "üì§ PREPARING TEST ARTIFACTS"
        echo "======================================"
        echo ""
        if [ -d "target/surefire-reports" ]; then
          echo "Test report files to upload:"
          ls -lh target/surefire-reports/*.xml 2>/dev/null || echo "No XML files found"
          echo ""
          echo "Total report files:"
          find target/surefire-reports -name "*.xml" | wc -l
        else
          echo "‚ö†Ô∏è No surefire-reports directory found"
        fi
        echo "======================================"

    - name: Upload a Build Artifact
      if: always()
      uses: actions/upload-artifact@v4.3.5
      with:
        name: ${{ inputs.artifact-name }}
        path: student-repo/target/surefire-reports/*.xml

  notify:
    runs-on: ubuntu-latest
    needs: build
    if: always()

    steps:
    - name: Notify completion
      run: |
        WEBHOOK_URL="${{ secrets.WEBHOOK_URL }}"
        if [ -z "$WEBHOOK_URL" ]; then
          WEBHOOK_URL="${{ inputs.webhook-url }}"
        fi
        
        # Skip if no webhook URL is provided
        if [ -z "$WEBHOOK_URL" ]; then
          echo "No webhook URL provided, skipping notification"
          exit 0
        fi

        STATUS="completed"
        if [ "${{ needs.build.result }}" != "success" ]; then
          STATUS="failed"
        fi

        curl -X POST "$WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "{
            \"status\": \"$STATUS\",
            \"repository\": {
              \"name\": \"${{ github.repository }}\",
              \"owner\": \"${{ github.repository_owner }}\"
            },
            \"branch\": \"${{ github.ref_name }}\",
            \"commit\": \"${{ github.sha }}\",
            \"runId\": \"${{ github.run_id }}\",
            \"runNumber\": \"${{ github.run_number }}\",
            \"conclusion\": \"${{ needs.build.result }}\"
          }"
